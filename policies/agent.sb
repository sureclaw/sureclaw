;; policies/agent.sb — Seatbelt sandbox for agent containers
;; Parameters: WORKSPACE, SKILLS, IPC_SOCKET_DIR, PROJECT_DIR, NODE_DIR
(version 1)
(deny default)

;; ── DENY all IP network FIRST (TCP/UDP — no internet access) ──
;; Specific unix socket allows below override this for local IPC only.
(deny network-outbound (remote ip))
(deny network-outbound (remote tcp))
(deny network-bind (remote ip))
(deny network-bind (remote tcp))

;; ── Agent data (read-write workspace, read-only skills) ──
(allow file-read* (subpath (param "WORKSPACE")))
(allow file-write* (subpath (param "WORKSPACE")))
(allow file-read* (subpath (param "SKILLS")))

;; ── IPC + proxy sockets (communication channels to host) ──
(allow file-read* file-write* (subpath (param "IPC_SOCKET_DIR")))
(allow network-outbound (remote unix-socket (subpath (param "IPC_SOCKET_DIR"))))

;; ── Localhost TCP for TCP-to-Unix-socket bridge (Agent SDK) ──
;; The bridge binds 127.0.0.1:PORT; Claude Code CLI connects via ANTHROPIC_BASE_URL.
;; All three are required: bind (create socket), inbound (accept), outbound (connect).
(allow network-bind (local ip "localhost:*"))
(allow network-inbound (local ip "localhost:*"))
(allow network-outbound (remote ip "localhost:*"))

;; ── Unix sockets for tsx/node internal IPC ──
(allow network-bind (local unix-socket))
(allow network-outbound (local unix-socket))
(allow network* (local unix-socket))

;; ── Project directory (node_modules, src — read-only) ──
(allow file-read* (subpath (param "PROJECT_DIR")))

;; ── Node.js runtime (version manager path, e.g. nvm/fnm/volta) ──
(allow file-read* (subpath (param "NODE_DIR")))

;; ── OS paths required by Node.js ──
(allow file-read* (literal "/"))
(allow file-read* (subpath "/usr"))
(allow file-read* (subpath "/opt"))
(allow file-read* (subpath "/dev"))
(allow file-write* (literal "/dev/null"))
(allow file-read* (subpath "/System/Library/OpenSSL"))
(allow file-read* (subpath "/private/etc"))
(allow file-read* (subpath "/etc"))
(allow file-read-metadata)

;; ── Temp directories (Node.js needs these for V8 compilation cache, etc.) ──
(allow file-read* (subpath "/tmp"))
(allow file-write* (subpath "/tmp"))
(allow file-read* (subpath "/private/tmp"))
(allow file-write* (subpath "/private/tmp"))
(allow file-read* (subpath "/private/var/folders"))
(allow file-write* (subpath "/private/var/folders"))
(allow file-read* (subpath "/var/folders"))
(allow file-write* (subpath "/var/folders"))

;; ── Process execution (required for Node.js, npx, tsx) ──
(allow process-exec)
(allow process-fork)
(allow sysctl-read)
(allow mach-lookup)
